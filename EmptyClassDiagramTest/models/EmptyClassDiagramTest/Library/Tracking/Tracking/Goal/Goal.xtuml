-- BP 7.1.6 content: ModelClass syschar: 3 persistence-version: 7.1.6

INSERT INTO O_OBJ
	VALUES ("fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'Goal',
	9,
	'Goal',
	'Each instance represents a particular goal as it is executing.
This class knows how to evaluate whether the goal is being achieved 
and whether the goal has completed.',
	"00000000-0000-0000-0000-000000000000");
INSERT INTO O_TFR
	VALUES ("616c4e01-62c7-435f-b7e6-f7c6c375dfae",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'create',
	'',
	"ba5eda7a-def5-0000-0000-000000000000",
	0,
	'// Create and activate an instance of a goal specified by
//   the goal specification, if it exists, identified by 
//   the incoming parameter.

// Find the goal specification for this goal, then
//   create and relate this goal to the specification
//   and to the singleton workout session.
select any goalSpec from instances of GoalSpec 
  where ( selected.sequenceNumber == param.sequenceNumber );
if ( not empty goalSpec )
  create object instance goal of Goal;
  relate goal to goalSpec across R9.''specified by'';
  select any session from instances of WorkoutSession;  // WorkoutSession is a singleton
  relate goal to session across R11.''is currently executing within'';

  // Initialize this goal.
  goal.calculateStart();
  goal.disposition = GoalDisposition::Increase;

  // Start a timer that periodically causes evaluation of goal achievement.
  create event instance evaluateEvent of Goal2:Evaluate to goal;
  goal.evaluationTimer = TIM::timer_start_recurring( event_inst: evaluateEvent, microseconds: evaluationPeriod );
end if;

',
	1,
	'',
	"00000000-0000-0000-0000-000000000000");
INSERT INTO O_TPARM
	VALUES ("49d905fc-beb3-4fc6-816a-c22bbcaec98c",
	"616c4e01-62c7-435f-b7e6-f7c6c375dfae",
	'sequenceNumber',
	"ba5eda7a-def5-0000-0000-000000000002",
	0,
	'',
	"00000000-0000-0000-0000-000000000000",
	'Sequence number of the goal specification for which an instance of a goal should be created.');
INSERT INTO O_TFR
	VALUES ("df593448-2df6-4ad8-8ee9-ba27902d3757",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'calculateStart',
	'',
	"ba5eda7a-def5-0000-0000-000000000000",
	1,
	'// Based on the span type for this goal, calculate and
//   store the value of the start attribute.
select one goalSpec related by self->GoalSpec[R9.''specified by''];
if ( goalSpec.spanType == GoalSpan::Time )
  select one workoutTimer related by 
    self->WorkoutSession[R11.''is currently executing within'']->WorkoutTimer[R8.''is timed by''];
  self.start = workoutTimer.time;
elif ( goalSpec.spanType == GoalSpan::Distance )
  select one session related by self->WorkoutSession[R11.''is currently executing within''];
  self.start = session.accumulatedDistance;
else
  LOG::LogFailure( message: "Goal.calculateStart: Unknown Goal Span Type." );
end if;',
	1,
	'',
	"616c4e01-62c7-435f-b7e6-f7c6c375dfae");
INSERT INTO O_TFR
	VALUES ("64db4097-58da-48a5-9b4f-e9ff2710f9f4",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'evaluateAchievement',
	'',
	"9765bf7d-c530-415f-8758-359f5639e1c4",
	1,
	'// Based on the type of goal, determine whether this one is 
//   currently being achieved and return a value indicating
//   the disposition of the this goal.    

// Find the related goal specification and workout session for this goal.
select one goalSpec related by self->GoalSpec[R9.''specified by''];
select one session related by self->WorkoutSession[R11.''is currently executing within''];

// Based on the goal criteria type, get the appropriate current value
//   for comparison against the criteria (minimum and maximum).
currentValue = 0.0;  // Explicit declaration
if ( goalSpec.criteriaType == GoalCriteria::HeartRate )
  currentValue = session.currentHeartRate;
elif ( goalSpec.criteriaType == GoalCriteria::Pace )
  currentValue = session.currentPace;
else
  LOG::LogFailure( message: "Goal.evaluateAchievement: Unknown Goal Criteria Type." );
end if;
 
// Compare the current value against the criteria to calculate the return value.
goalDisposition = GoalDisposition::Achieving; 
if ( currentValue < goalSpec.minimum )
  goalDisposition = GoalDisposition::Increase;
elif ( currentValue > goalSpec.maximum )
  goalDisposition = GoalDisposition::Decrease;
end if;

// Invert the disposition value to produce a logical, semantic disposition for
//   goal types, such as pace, that require it.
if ( goalSpec.criteriaType == GoalCriteria::Pace )
  if ( goalDisposition == GoalDisposition::Increase )
    goalDisposition = GoalDisposition::Decrease;
  elif ( goalDisposition == GoalDisposition::Decrease )
    goalDisposition = GoalDisposition::Increase;
  end if;
end if;
 
return( goalDisposition );',
	1,
	'',
	"df593448-2df6-4ad8-8ee9-ba27902d3757");
INSERT INTO S_DT_PROXY
	VALUES ("9765bf7d-c530-415f-8758-359f5639e1c4",
	"00000000-0000-0000-0000-000000000000",
	'GoalDisposition',
	'Disposition of a currently executing goal.',
	'',
	'../../../../TrackingDataTypes/TrackingDataTypes.xtuml');
INSERT INTO O_TFR
	VALUES ("5632f19a-0900-41c7-b1af-299485b9b1ec",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'evaluateCompletion',
	'',
	"ba5eda7a-def5-0000-0000-000000000000",
	1,
	'// Based on the span type for this goal, determine 
//  whether it has been completed, update achievement
//  records as necessary, and advance to the next goal
//  if appropriate.

select one goalSpec related by self->GoalSpec[R9.''specified by''];

// Based on the span type for the goal, get the elapsed span 
//   for comparison against the specified span for the goal.
elapsedSpan = 0.0;  // Explicit declaration
if ( goalSpec.spanType == GoalSpan::Distance )
  select one session related by self->WorkoutSession[R11.''is currently executing within''];
  elapsedSpan = session.accumulatedDistance - self.start;
elif ( goalSpec.spanType == GoalSpan::Time )
  select one workoutTimer related by 
    self->WorkoutSession[R11.''is currently executing within'']->WorkoutTimer[R8.''is timed by''];
  elapsedSpan = workoutTimer.time - self.start;
else
  LOG::LogFailure( message: "Goal.evaluateCompletion: Unknown Goal Span Type." );
end if;

// Compare the current value against the specified span to determine 
//   whether the execution of this workout goal is complete.
if ( elapsedSpan >= goalSpec.span )
  select one openAchievement related by self->Achievement[R14.''has open''];
  if ( not empty openAchievement )
    openAchievement.close();
  end if;
  generate Goal1:Completed to self;
end if;
',
	1,
	'',
	"64db4097-58da-48a5-9b4f-e9ff2710f9f4");
INSERT INTO O_TFR
	VALUES ("b0ef3be2-36c7-42ff-8d5d-7cd93889871a",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	'nextGoal',
	'',
	"ba5eda7a-def5-0000-0000-000000000000",
	0,
	'// Advance to the next goal or start the first one if one
//   is currently not exectuing.

//  If there is a goal currently executing, notify it that its execution
//    has completed.
//  Otherwise, create and start a goal for the first goal specification
//    if one exists.
select any session from instances of WorkoutSession;  // WorkoutSession is a singleton.
if ( not empty session )
  select one goal related by session->Goal[R11.''is currently executing''];
  if ( not empty goal )
    generate Goal1:Completed to goal;
  else
    Goal::create( sequenceNumber: GoalSpecOrigin );
  end if;
end if;',
	1,
	'',
	"5632f19a-0900-41c7-b1af-299485b9b1ec");
INSERT INTO O_NBATTR
	VALUES ("76699226-d3ef-49a4-b1d4-1948ff9f3dd7",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_BATTR
	VALUES ("76699226-d3ef-49a4-b1d4-1948ff9f3dd7",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ATTR
	VALUES ("76699226-d3ef-49a4-b1d4-1948ff9f3dd7",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	"f6d18769-ce89-4215-a446-260e98ac1531",
	'disposition',
	'The disposition of this goal.  See data type descriptions for details.
This attribute represents the logical or semantic disposition of the goal.
For example, a disposition indicating the need to increase the value in question
for a heart-rate goal means that activity should be increased to drive up the 
heart rate.  Since pace is the inverse of speed, a disposition indicating 
the need to increase the value in question (pace) means that the user must
increase speed, causing a lower (faster) pace number.',
	'',
	'disposition',
	0,
	"9765bf7d-c530-415f-8758-359f5639e1c4",
	'',
	'');
INSERT INTO O_NBATTR
	VALUES ("f6d18769-ce89-4215-a446-260e98ac1531",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_BATTR
	VALUES ("f6d18769-ce89-4215-a446-260e98ac1531",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ATTR
	VALUES ("f6d18769-ce89-4215-a446-260e98ac1531",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	"e442d7d0-78c3-4f05-b441-33a32b8715dc",
	'start',
	'Captures the starting point of the span for this particular goal so 
that the end of the goal execution period can be determined.  In other
words, using the value of this attribute together with the span specified
by the associated goal specification, the goal knows when it is finished.

For distance-based goals, it is expressed as the accumulated distance
in meters for the associated workout session at the time this goal
execution commenced.

For time-based goals, it is expressed as the elapsed time in seconds
for the associated workout session at the time this goal execution
commenced.',
	'',
	'start',
	0,
	"ba5eda7a-def5-0000-0000-000000000003",
	'',
	'');
INSERT INTO O_NBATTR
	VALUES ("e442d7d0-78c3-4f05-b441-33a32b8715dc",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_BATTR
	VALUES ("e442d7d0-78c3-4f05-b441-33a32b8715dc",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ATTR
	VALUES ("e442d7d0-78c3-4f05-b441-33a32b8715dc",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	"00000000-0000-0000-0000-000000000000",
	'ID',
	'An arbitrary identifier.',
	'',
	'ID',
	0,
	"ba5eda7a-def5-0000-0000-000000000005",
	'',
	'');
INSERT INTO O_NBATTR
	VALUES ("d8eb9ae0-397f-4481-8f4d-0cdb56067492",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_BATTR
	VALUES ("d8eb9ae0-397f-4481-8f4d-0cdb56067492",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ATTR
	VALUES ("d8eb9ae0-397f-4481-8f4d-0cdb56067492",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	"5f166016-365a-4e73-8e01-125c586129dd",
	'current_state',
	'',
	'',
	'current_state',
	0,
	"ba5eda7a-def5-0000-0000-000000000006",
	'',
	'');
INSERT INTO O_NBATTR
	VALUES ("5f166016-365a-4e73-8e01-125c586129dd",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_BATTR
	VALUES ("5f166016-365a-4e73-8e01-125c586129dd",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ATTR
	VALUES ("5f166016-365a-4e73-8e01-125c586129dd",
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	"76699226-d3ef-49a4-b1d4-1948ff9f3dd7",
	'evaluationTimer',
	'Handle for the timer used for periodic evaluation of goal achievement.',
	'',
	'evaluationTimer',
	0,
	"ba5eda7a-def5-0000-0000-00000000000f",
	'',
	'');
INSERT INTO O_ID
	VALUES (0,
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ID
	VALUES (1,
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO O_ID
	VALUES (2,
	"fcf5de4a-8be2-4787-bfd9-697d3b06bc43");
INSERT INTO PE_PE
	VALUES ("fcf5de4a-8be2-4787-bfd9-697d3b06bc43",
	1,
	"b5bdfd2d-2370-4d36-af96-47b0b1b4f153",
	"00000000-0000-0000-0000-000000000000",
	4);
INSERT INTO EP_PKG_PROXY
	VALUES ("b5bdfd2d-2370-4d36-af96-47b0b1b4f153",
	"00000000-0000-0000-0000-000000000000",
	"efdd2203-0401-4fcb-8009-7a63fd421608",
	'Tracking',
	'',
	0,
	'../Tracking.xtuml');
